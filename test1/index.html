<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>NOVA MINING | REAL SOL STAKING</title>
    <!-- Font & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for easy theme management */
        :root {
            --primary-glow: rgba(0, 255, 255, 0.6);
            --secondary-glow: rgba(0, 150, 255, 0.4);
            --bg-dark: #030b14;
            --card-bg: rgba(8, 25, 40, 0.6);
            --border-color: rgba(0, 255, 255, 0.25);
            --text-primary: #ffffff;
            --text-secondary: #b0e0ff;
            --accent-cyan: #00ffff;
            --accent-blue: #0088ff;
            --success-green: #00ffaa;
            --warning-gold: #ffd700;
            --spacing-xs: clamp(0.25rem, 1vw, 0.5rem);
            --spacing-sm: clamp(0.5rem, 2vw, 0.75rem);
            --spacing-md: clamp(0.75rem, 3vw, 1rem);
            --spacing-lg: clamp(1rem, 4vw, 1.5rem);
            --spacing-xl: clamp(1.5rem, 5vw, 2rem);
            --font-size-xs: clamp(0.7rem, 2vw, 0.8rem);
            --font-size-sm: clamp(0.8rem, 2.5vw, 0.9rem);
            --font-size-md: clamp(0.9rem, 3vw, 1rem);
            --font-size-lg: clamp(1.1rem, 4vw, 1.3rem);
            --font-size-xl: clamp(1.5rem, 6vw, 2rem);
            --font-size-xxl: clamp(1.8rem, 7vw, 2.5rem);
            --border-radius-sm: clamp(0.8rem, 3vw, 1rem);
            --border-radius-md: clamp(1rem, 4vw, 1.5rem);
            --border-radius-lg: clamp(1.5rem, 5vw, 2rem);
            --border-radius-xl: clamp(2rem, 6vw, 3rem);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at 0% 0%, #1a3a4f, #0b1f30, #030b14);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .mining-app {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .glass-panel {
            width: 100%;
            background: rgba(5, 20, 30, 0.35);
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: 0 30px 60px -20px rgba(0, 0, 0, 0.8), 
                        0 0 0 1px rgba(0, 255, 255, 0.1) inset,
                        0 0 40px rgba(0, 255, 255, 0.1);
        }

        .mining-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            position: relative;
        }

        .mining-header h1 {
            font-size: var(--font-size-xxl);
            font-weight: 800;
            background: linear-gradient(135deg, #7ff0ff, #4da8ff, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            letter-spacing: 2px;
            margin-bottom: var(--spacing-xs);
            animation: glowPulse 3s infinite;
        }

        @keyframes glowPulse {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.3)); }
            50% { filter: drop-shadow(0 0 40px rgba(0, 255, 255, 0.7)); }
        }

        .mining-header p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            opacity: 0.9;
            letter-spacing: 1px;
        }

        .wallet-section {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .wallet-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .wallet-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(0, 255, 255, 0.08);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-xl);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .wallet-badge i {
            font-size: var(--font-size-lg);
            color: var(--accent-cyan);
            filter: drop-shadow(0 0 10px cyan);
        }

        .wallet-badge span {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text-primary);
        }

        .wallet-address-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .wallet-address {
            font-size: var(--font-size-sm);
            background: rgba(0, 0, 0, 0.5);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-xl);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #a5f0ff;
            font-family: monospace;
            letter-spacing: 1px;
            word-break: break-all;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-xl);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .status-active {
            background: rgba(0, 255, 170, 0.15);
            border: 1px solid #00ffaa;
            color: #00ffaa;
        }

        .btn {
            background: rgba(0, 150, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.4);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-xl);
            font-weight: 600;
            font-size: var(--font-size-md);
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 100, 255, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            min-height: 48px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.4), rgba(0, 100, 255, 0.4));
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            font-size: var(--font-size-lg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 180px), 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }

        .stat-card {
            background: rgba(0, 20, 35, 0.7);
            backdrop-filter: blur(5px);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            border: 1px solid rgba(0, 255, 200, 0.2);
            transition: transform 0.2s ease;
        }

        .stat-card:active {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: calc(var(--font-size-xl) * 1.5);
            color: var(--accent-cyan);
            margin-bottom: var(--spacing-sm);
            filter: drop-shadow(0 0 15px cyan);
        }

        .stat-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: white;
            line-height: 1.2;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            word-break: break-word;
        }

        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: var(--spacing-xs);
        }

        .mining-power-card {
            background: rgba(0, 15, 25, 0.8);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .power-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-md);
            color: var(--text-secondary);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .power-bar-container {
            width: 100%;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .power-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00ffaa, #00ffff, #0088ff);
            border-radius: var(--border-radius-xl);
            transition: width 0.5s ease;
            box-shadow: 0 0 20px cyan;
        }

        .tier-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background: rgba(0, 10, 20, 0.6);
            border-radius: var(--border-radius-lg);
        }

        .tier-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid gold;
            border-radius: var(--border-radius-xl);
            font-weight: 600;
            font-size: var(--font-size-md);
        }

        .tier-badge i {
            color: gold;
        }

        .boost-multiplier {
            color: gold;
            font-weight: 700;
            animation: boostPulse 2s infinite;
        }

        @keyframes boostPulse {
            0%, 100% { text-shadow: 0 0 5px gold; }
            50% { text-shadow: 0 0 20px gold; }
        }

        .stake-container {
            margin: var(--spacing-lg) 0;
        }

        .stake-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
            font-size: var(--font-size-md);
        }

        .input-group {
            display: flex;
            align-items: stretch;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .stake-input-wrapper {
            flex: 3;
            min-width: 200px;
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            border-radius: var(--border-radius-xl);
            border: 1px solid rgba(0, 255, 255, 0.3);
            overflow: hidden;
        }

        .stake-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: var(--spacing-md);
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: white;
            outline: none;
            min-width: 120px;
        }

        .stake-input::placeholder {
            color: rgba(180, 210, 240, 0.4);
        }

        .stake-unit {
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            background: rgba(0, 100, 200, 0.3);
            color: var(--accent-cyan);
            font-weight: 700;
            border-left: 1px solid rgba(0, 255, 255, 0.3);
        }

        .quick-stake-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin: var(--spacing-md) 0;
        }

        .quick-btn {
            flex: 1;
            min-width: 80px;
            background: rgba(0, 100, 200, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-xl);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:active {
            background: rgba(0, 200, 255, 0.3);
        }

        .feed-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .hash-rate {
            color: var(--success-green);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .mining-feed {
            max-height: 120px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-cyan) rgba(0, 0, 0, 0.3);
        }

        .mining-feed::-webkit-scrollbar {
            width: 4px;
        }

        .mining-feed::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .mining-feed::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }

        .feed-item {
            padding: var(--spacing-xs) 0;
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .feed-item i {
            font-size: var(--font-size-xs);
        }

        .feed-item .success { color: var(--success-green); }
        .feed-item .mining { color: var(--warning-gold); }
        .feed-item .info { color: var(--accent-cyan); }
        .feed-item .warning { color: #ff6b6b; }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(3, 10, 18, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: var(--spacing-md);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-card {
            background: rgba(10, 25, 40, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid var(--accent-cyan);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px #00000080, 0 0 50px rgba(0, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .modal-header i {
            font-size: var(--font-size-xl);
            color: var(--accent-cyan);
        }

        .modal-header h3 {
            font-size: var(--font-size-lg);
            color: white;
        }

        .modal-body {
            margin-bottom: var(--spacing-lg);
        }

        .modal-detail {
            background: #0a1c2b;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            word-break: break-word;
            border: 1px solid #214767;
            font-size: var(--font-size-sm);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        .app-footer {
            margin-top: var(--spacing-lg);
            text-align: center;
            color: rgba(176, 224, 255, 0.5);
            font-size: var(--font-size-xs);
        }

        .text-gradient {
            background: linear-gradient(135deg, #00ffff, #0088ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glow-text {
            text-shadow: 0 0 10px currentColor;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .w-100 { width: 100%; }
        .mt-2 { margin-top: var(--spacing-md); }
        .mb-2 { margin-bottom: var(--spacing-md); }

        .min-stake-notice {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            margin: var(--spacing-sm) 0;
            color: var(--warning-gold);
            font-size: var(--font-size-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
    </style>
</head>
<body>
    <div class="mining-app">
        <div class="glass-panel">
            <!-- Header -->
            <div class="mining-header">
                <h1>âš¡ NOVA MINING</h1>
                <p>real solana staking Â· 10% daily Â· tier boosts</p>
            </div>

            <!-- Wallet Section -->
            <div class="wallet-section">
                <div class="wallet-container">
                    <div class="wallet-badge">
                        <i class="fas fa-bolt"></i>
                        <span>MINING RIG</span>
                    </div>
                    <button class="btn" id="connectWalletBtn">
                        <i class="fab fa-phantom"></i>
                        <span class="btn-text">CONNECT PHANTOM</span>
                    </button>
                </div>
                
                <div id="walletInfo" style="display: none;" class="mt-2">
                    <div class="wallet-address-container">
                        <div class="wallet-address" id="walletAddressDisplay"></div>
                        <span class="status-badge status-active">
                            <i class="fas fa-circle"></i> MINING
                        </span>
                    </div>
                </div>
            </div>

            <!-- Mining Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-coins"></i></div>
                    <div class="stat-value" id="totalStakedDisplay">0.0000</div>
                    <div class="stat-label">STAKED SOL</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="dailyRewardDisplay">0.0000</div>
                    <div class="stat-label">DAILY REWARD</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-gauge-high"></i></div>
                    <div class="stat-value" id="miningSpeed">0.0000</div>
                    <div class="stat-label">SOL/HR</div>
                </div>
            </div>

            <!-- Mining Power Bar -->
            <div class="mining-power-card">
                <div class="power-header">
                    <span><i class="fas fa-bolt"></i> MINING POWER</span>
                    <span id="powerPercentage">0%</span>
                </div>
                <div class="power-bar-container">
                    <div class="power-bar-fill" id="powerFill" style="width: 0%;"></div>
                </div>
            </div>

            <!-- Tier & Boost Info -->
            <div class="tier-container">
                <div class="tier-badge">
                    <i class="fas fa-crown"></i>
                    <span id="minerTier">BRONZE MINER</span>
                </div>
                <div class="flex-row">
                    <span style="color: var(--text-secondary);">BOOST:</span>
                    <span class="boost-multiplier" id="boostMultiplier">1.0x</span>
                </div>
                <div style="color: var(--text-secondary);" id="nextTierInfo">
                    <i class="fas fa-arrow-up"></i> 0/10 SOL
                </div>
            </div>

            <!-- Stake Controls -->
            <div class="stake-container">
                <div class="stake-label">
                    <i class="fas fa-microchip"></i>
                    <span>ADD MINING POWER</span>
                </div>
                
                <div class="min-stake-notice">
                    <i class="fas fa-info-circle"></i>
                    <span>Minimum stake: 0.5 SOL (~$100 USD)</span>
                </div>
                
                <div class="input-group">
                    <div class="stake-input-wrapper">
                        <input type="number" id="stakeAmount" class="stake-input" placeholder="0.5" min="0.5" step="0.1" value="0.5">
                        <span class="stake-unit">SOL</span>
                    </div>
                    <button class="btn btn-primary" id="stakeBtn" style="flex: 1; min-width: 120px;">
                        <i class="fa-solid fa-bolt"></i>
                        <span>MINE</span>
                    </button>
                </div>

                <div class="quick-stake-buttons">
                    <button class="quick-btn" id="quickStake0_5">+0.5 SOL</button>
                    <button class="quick-btn" id="quickStake1">+1 SOL</button>
                    <button class="quick-btn" id="quickStake5">+5 SOL</button>
                    <button class="quick-btn" id="quickStake10">+10 SOL</button>
                </div>
            </div>

            <!-- Live Mining Feed -->
            <div class="feed-container">
                <div class="feed-header">
                    <span><i class="fas fa-wave-square"></i> LIVE MINING FEED</span>
                    <span class="hash-rate" id="hashRate">âš¡ 0 H/s</span>
                </div>
                <div class="mining-feed" id="miningFeed">
                    <div class="feed-item">
                        <i class="fas fa-circle info"></i>
                        <span>system online Â· waiting for miner...</span>
                    </div>
                </div>
            </div>

            <!-- Last Update -->
            <div class="flex-row" style="justify-content: space-between; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid rgba(0,255,255,0.1);">
                <span style="color: var(--text-secondary);"><i class="fa-regular fa-clock"></i> LAST MINING CYCLE</span>
                <span style="color: var(--text-secondary);" id="lastUpdateTimestamp">â€”</span>
            </div>

            <!-- Footer -->
            <div class="app-footer">
                <i class="fa-regular fa-gem"></i> mining pool: AMC3gY5q...JyeJc Â· 10% daily compound with tier boosts
            </div>
        </div>
    </div>

    <!-- Transaction Modal (REAL CONFIRMATION) -->
    <div class="modal-overlay" id="txModal">
        <div class="modal-card">
            <div class="modal-header">
                <i class="fa-solid fa-bolt"></i>
                <h3>REAL MINING TX</h3>
            </div>
            <div class="modal-body">
                <div id="modalMessage" style="margin-bottom: var(--spacing-md); color: var(--text-secondary);">processing...</div>
                <div class="modal-detail" id="modalDetail"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="modalCloseBtn">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@1.95.8/lib/index.iife.min.js"></script>

    <!-- Firebase + Application Logic (NO BUFFER, REAL CONFIRMATION) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCck4gA4cLcJfir9nJAigdZrVC8r91gciE",
            authDomain: "nova-e6655.firebaseapp.com",
            databaseURL: "https://nova-e6655-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nova-e6655",
            storageBucket: "nova-e6655.firebasestorage.app",
            messagingSenderId: "111451913127",
            appId: "1:111451913127:web:8cb6c4f1715daf0ff69482"
        };
        
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        const RECEIVER_ADDRESS = "AMC3gY5qJxxF6sNcPzzsmFvpucJJvBydLCiZggaJyeJc";
        const MIN_STAKE_SOL = 0.5; // Minimum 0.5 SOL (~$100 USD)
        
        // Helius RPC for reliable mainnet connection
        const HELIUS_RPC = "https://mainnet.helius-rpc.com/?api-key=a6328d07-7441-42c2-afb0-3bcd6a932c17";
        
        let phantom = null;
        let walletAddress = null;
        let userDocRef = null;
        let miningInterval = null;
        let feedItems = [];

        // UI Elements
        const connectBtn = document.getElementById('connectWalletBtn');
        const walletInfoDiv = document.getElementById('walletInfo');
        const walletAddrSpan = document.getElementById('walletAddressDisplay');
        const stakeBtn = document.getElementById('stakeBtn');
        const stakeAmountInput = document.getElementById('stakeAmount');
        const totalStakedSpan = document.getElementById('totalStakedDisplay');
        const dailyRewardSpan = document.getElementById('dailyRewardDisplay');
        const miningSpeedSpan = document.getElementById('miningSpeed');
        const powerFill = document.getElementById('powerFill');
        const powerPercentage = document.getElementById('powerPercentage');
        const minerTierSpan = document.getElementById('minerTier');
        const nextTierInfo = document.getElementById('nextTierInfo');
        const boostMultiplierSpan = document.getElementById('boostMultiplier');
        const hashRateSpan = document.getElementById('hashRate');
        const miningFeed = document.getElementById('miningFeed');
        const lastUpdateSpan = document.getElementById('lastUpdateTimestamp');
        const modalOverlay = document.getElementById('txModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalDetail = document.getElementById('modalDetail');
        const modalClose = document.getElementById('modalCloseBtn');

        // Quick stake buttons
        const quickStake0_5 = document.getElementById('quickStake0_5');
        const quickStake1 = document.getElementById('quickStake1');
        const quickStake5 = document.getElementById('quickStake5');
        const quickStake10 = document.getElementById('quickStake10');

        // Helper Functions
        function showModal(title, detail) {
            modalMessage.innerText = title;
            modalDetail.innerText = detail;
            modalOverlay.classList.add('active');
        }

        modalClose.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });

        function formatAddr(addr) {
            if (!addr) return '';
            if (addr.length <= 8) return addr;
            return addr.slice(0,4) + '...' + addr.slice(-4);
        }

        function getPhantom() {
            if (window?.phantom?.solana) return window.phantom.solana;
            if (window?.solana?.isPhantom) return window.solana;
            return null;
        }

        // Add to mining feed
        function addToFeed(message, type = 'info') {
            const iconMap = {
                success: 'fa-check-circle success',
                mining: 'fa-bolt mining',
                info: 'fa-circle info',
                warning: 'fa-exclamation-triangle warning'
            };
            
            const icon = iconMap[type] || iconMap.info;
            
            feedItems.unshift({ message, type, time: Date.now() });
            if (feedItems.length > 8) feedItems.pop();
            
            updateFeed();
        }

        function updateFeed() {
            miningFeed.innerHTML = feedItems.map(item => `
                <div class="feed-item">
                    <i class="fas ${item.type === 'success' ? 'fa-check-circle success' : 
                                     item.type === 'mining' ? 'fa-bolt mining' : 
                                     item.type === 'warning' ? 'fa-exclamation-triangle warning' : 
                                     'fa-circle info'}"></i>
                    <span>${item.message}</span>
                </div>
            `).join('');
        }

        // Calculate tier and boost
        function calculateTier(totalStaked) {
            if (totalStaked >= 100) return { tier: 'DIAMOND', boost: 2.5, next: null, color: '#b9f2ff' };
            if (totalStaked >= 50) return { tier: 'PLATINUM', boost: 2.0, next: 100, color: '#e5e4e2' };
            if (totalStaked >= 25) return { tier: 'GOLD', boost: 1.5, next: 50, color: 'gold' };
            if (totalStaked >= 10) return { tier: 'SILVER', boost: 1.2, next: 25, color: 'silver' };
            return { tier: 'BRONZE', boost: 1.0, next: 10, color: '#cd7f32' };
        }

        // Update all mining stats
        function updateMiningStats(totalStaked) {
            const powerLevel = Math.min(100, (totalStaked / 100) * 100);
            powerFill.style.width = `${powerLevel}%`;
            powerPercentage.innerText = `${Math.round(powerLevel)}%`;
            
            const tierInfo = calculateTier(totalStaked);
            minerTierSpan.innerText = tierInfo.tier + ' MINER';
            boostMultiplierSpan.innerText = tierInfo.boost + 'x';
            
            if (tierInfo.next) {
                const currentTierMin = tierInfo.tier === 'BRONZE' ? 0 : 
                                       tierInfo.tier === 'SILVER' ? 10 : 
                                       tierInfo.tier === 'GOLD' ? 25 : 50;
                const progress = totalStaked - currentTierMin;
                const needed = tierInfo.next - currentTierMin;
                nextTierInfo.innerHTML = `<i class="fas fa-arrow-up"></i> ${progress.toFixed(2)}/${needed} SOL`;
            } else {
                nextTierInfo.innerHTML = '<i class="fas fa-crown"></i> MAX TIER';
            }
            
            const hourlyRate = (totalStaked * 0.1 * tierInfo.boost) / 24;
            miningSpeedSpan.innerText = hourlyRate.toFixed(4);
            
            const hashRate = Math.round(totalStaked * 1000);
            hashRateSpan.innerHTML = `âš¡ ${hashRate.toLocaleString()} H/s`;
        }

        // FIREBASE FUNCTIONS
        async function loadUserData(address) {
            if (!address) return null;
            
            const docId = address;
            userDocRef = doc(db, 'stakes', docId);
            
            try {
                const snap = await getDoc(userDocRef);
                
                if (snap.exists()) {
                    console.log('Found existing user data');
                    addToFeed('ðŸ“Š loaded existing mining data', 'info');
                    return snap.data();
                } else {
                    console.log('No existing data, creating new user');
                    const now = Date.now();
                    const newData = {
                        wallet: address,
                        totalStaked: 0,
                        lastDailyUpdate: now,
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(userDocRef, newData);
                    addToFeed('ðŸš€ new mining rig deployed', 'success');
                    return newData;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                addToFeed('âš ï¸ error loading mining data', 'warning');
                return null;
            }
        }

        // Calculate and apply daily rewards
        async function calculateDailyRewards(currentData) {
            if (!currentData) return null;
            
            const now = Date.now();
            const lastUpdate = currentData.lastDailyUpdate || now;
            const daysPassed = Math.floor((now - lastUpdate) / (86400 * 1000));
            
            if (daysPassed > 0 && currentData.totalStaked > 0) {
                let total = currentData.totalStaked;
                const tierInfo = calculateTier(total);
                
                // Apply daily rewards with boost
                for (let i = 0; i < daysPassed; i++) {
                    total = total * (1 + (0.1 * tierInfo.boost));
                }
                
                // Update in Firestore
                await updateDoc(userDocRef, {
                    totalStaked: total,
                    lastDailyUpdate: now
                });
                
                addToFeed(`â›ï¸ mined ${daysPassed} day(s) Â· ${tierInfo.boost}x boost`, 'mining');
                
                return { ...currentData, totalStaked: total, lastDailyUpdate: now };
            }
            
            return currentData;
        }

        // Refresh UI with latest data
        async function refreshUserStats() {
            if (!userDocRef || !walletAddress) return;
            
            const snap = await getDoc(userDocRef);
            if (!snap.exists()) return;
            
            const data = snap.data();
            const total = data.totalStaked || 0;
            const last = data.lastDailyUpdate ? new Date(data.lastDailyUpdate).toLocaleString() : 'just now';
            
            const tierInfo = calculateTier(total);
            const dailyReward = total * 0.1 * tierInfo.boost;
            
            totalStakedSpan.innerText = total.toFixed(4);
            dailyRewardSpan.innerText = dailyReward.toFixed(4);
            lastUpdateSpan.innerText = last;
            
            updateMiningStats(total);
        }

        // Add stake and update Firestore
        async function addStakeToFirestore(amountSol) {
            if (!userDocRef || !walletAddress) return;
            
            const snap = await getDoc(userDocRef);
            if (!snap.exists()) return;
            
            const currentTotal = snap.data().totalStaked || 0;
            const newTotal = currentTotal + amountSol;
            
            await updateDoc(userDocRef, {
                totalStaked: newTotal,
                lastDailyUpdate: Date.now()
            });
            
            await refreshUserStats();
            addToFeed(`ðŸ“¦ +${amountSol} SOL added to mining rig`, 'success');
        }

        // Connect Phantom
        async function connectPhantom() {
            phantom = getPhantom();
            
            if (!phantom) {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    if (confirm("Open Phantom app to start mining?")) {
                        window.location.href = "phantom://browse";
                        setTimeout(() => {
                            window.location.href = "https://phantom.app/ul/browse";
                        }, 1000);
                    }
                } else {
                    window.open("https://phantom.app/", "_blank");
                    alert("Please install Phantom wallet to start mining");
                }
                return;
            }

            try {
                connectBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i><span class="btn-text">LOADING...</span>';
                
                const resp = await phantom.connect();
                walletAddress = resp.publicKey.toString();
                
                const userData = await loadUserData(walletAddress);
                
                if (userData) {
                    const updatedData = await calculateDailyRewards(userData);
                    
                    walletAddrSpan.innerText = formatAddr(walletAddress);
                    walletInfoDiv.style.display = 'block';
                    connectBtn.innerHTML = '<i class="fab fa-phantom"></i><span class="btn-text">MINING ACTIVE</span>';
                    connectBtn.style.background = 'rgba(0, 255, 170, 0.15)';
                    connectBtn.style.borderColor = '#00ffaa';
                    
                    await refreshUserStats();
                    addToFeed('ðŸ”Œ mining rig connected to network', 'success');
                    
                    startMiningSimulation();
                }
                
            } catch (err) {
                console.error('Connection error:', err);
                alert('Failed to connect: ' + err.message);
                connectBtn.innerHTML = '<i class="fab fa-phantom"></i><span class="btn-text">CONNECT PHANTOM</span>';
            }
        }

        // REAL TRANSACTION: Send stake with wallet confirmation (NO BUFFER)
        async function sendStake(amount = null) {
            if (!walletAddress || !phantom) {
                alert("Connect your mining rig first");
                return;
            }

            const stakeAmount = amount || parseFloat(stakeAmountInput.value);
            
            // Validate minimum stake (0.5 SOL = ~$100)
            if (isNaN(stakeAmount) || stakeAmount < MIN_STAKE_SOL) {
                alert(`Minimum stake is ${MIN_STAKE_SOL} SOL (~$${(MIN_STAKE_SOL * 200).toFixed(0)} USD)`);
                return;
            }

            // Show modal immediately â€“ user must approve in wallet
            showModal("â›ï¸ AWAITING WALLET APPROVAL", `Amount: ${stakeAmount} SOL\n\nPlease approve the transaction in your Phantom wallet.\n\nAfter approval, we wait for blockchain confirmation.`);

            try {
                if (!phantom.publicKey) {
                    await phantom.connect();
                }

                addToFeed('ðŸ“ creating transaction...', 'info');

                // Create connection to Solana network
                const connection = new solanaWeb3.Connection(HELIUS_RPC, 'confirmed');
                
                // Get latest blockhash
                let blockhash, lastValidBlockHeight;
                try {
                    const result = await connection.getLatestBlockhash('finalized');
                    blockhash = result.blockhash;
                    lastValidBlockHeight = result.lastValidBlockHeight;
                } catch (blockhashError) {
                    console.error('Blockhash error:', blockhashError);
                    // Fallback to public RPC
                    const publicConnection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
                    const result = await publicConnection.getLatestBlockhash('finalized');
                    blockhash = result.blockhash;
                    lastValidBlockHeight = result.lastValidBlockHeight;
                }

                // Create the transfer instruction
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: phantom.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(RECEIVER_ADDRESS),
                        lamports: Math.floor(stakeAmount * solanaWeb3.LAMPORTS_PER_SOL)
                    })
                );
                
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = phantom.publicKey;

                // Update modal to tell user to approve in wallet
                modalMessage.innerText = "ðŸ” APPROVE IN WALLET";
                modalDetail.innerText = `Please approve this transaction in your Phantom wallet:\n\nAmount: ${stakeAmount} SOL\nTo: ${RECEIVER_ADDRESS.slice(0,8)}...${RECEIVER_ADDRESS.slice(-8)}\n\nWaiting for your approval...`;

                addToFeed('â³ waiting for wallet approval...', 'info');

                // This triggers the Phantom wallet popup for REAL confirmation
                const { signature } = await phantom.signAndSendTransaction(transaction);
                
                modalMessage.innerText = "â³ TRANSACTION SENT, CONFIRMING...";
                modalDetail.innerText = `Transaction Signature:\n${signature}\n\nWaiting for blockchain confirmation...\n\nThis may take 10-30 seconds.`;
                
                addToFeed(`ðŸ“¤ tx sent: ${signature.slice(0,8)}...`, 'mining');
                
                // Wait for confirmation on blockchain
                const confirmation = await connection.confirmTransaction({
                    signature,
                    blockhash,
                    lastValidBlockHeight
                }, 'confirmed');

                if (confirmation.value.err) {
                    throw new Error('Transaction failed on blockchain: ' + JSON.stringify(confirmation.value.err));
                }
                
                // Transaction confirmed! Update Firebase
                await addStakeToFirestore(stakeAmount);
                
                modalMessage.innerText = "âœ… MINING STARTED!";
                modalDetail.innerText = `ðŸŽ‰ Transaction Confirmed!\n\nSignature: ${signature}\n\nAmount Staked: ${stakeAmount} SOL\nValue: ~$${(stakeAmount * 200).toFixed(2)} USD\n\nStatus: âœ“ Confirmed on Solana\nYour mining rig is now active and generating rewards!`;
                
                addToFeed(`â›ï¸ ${stakeAmount} SOL staked successfully!`, 'success');
                addToFeed(`âœ… confirmed: ${signature.slice(0,12)}...`, 'success');
                
                // Refresh all stats
                await refreshUserStats();
                
            } catch (err) {
                console.error('Transaction error:', err);
                modalMessage.innerText = "âŒ TRANSACTION FAILED";
                
                let errorMsg = 'Transaction failed.';
                
                if (err.message.includes('User rejected')) {
                    errorMsg = 'âŒ You rejected the transaction in your Phantom wallet.\n\nNo funds were transferred.';
                    addToFeed('âš ï¸ transaction rejected by user', 'warning');
                } else if (err.message.includes('insufficient')) {
                    errorMsg = 'âŒ Insufficient SOL balance.\n\nPlease make sure you have enough SOL to cover the stake amount plus network fees (~0.000005 SOL).';
                    addToFeed('âš ï¸ insufficient balance', 'warning');
                } else if (err.message.includes('Attempt to debit')) {
                    errorMsg = 'âŒ Insufficient balance.\n\nYou need more SOL in your wallet.';
                    addToFeed('âš ï¸ insufficient funds', 'warning');
                } else {
                    errorMsg = `âŒ Transaction Error:\n\n${err.message}`;
                    addToFeed('âš ï¸ transaction failed', 'warning');
                }
                
                modalDetail.innerText = errorMsg;
            }
        }

        // Mining simulation (visual only, does not affect real balance)
        function startMiningSimulation() {
            if (miningInterval) clearInterval(miningInterval);
            
            const events = [
                'âš¡ hashing at full power',
                'ðŸ” validating new block',
                'ðŸ“Š calculating rewards',
                'ðŸ’Ž rare gem discovered',
                'ðŸ”„ syncing with network',
                'âš™ï¸ optimizing mining rig',
                'ðŸŒ connected to 12 peers',
                'ðŸ”— block validated'
            ];
            
            miningInterval = setInterval(async () => {
                if (!userDocRef || !walletAddress) return;
                
                if (Math.random() > 0.6) {
                    const randomEvent = events[Math.floor(Math.random() * events.length)];
                    addToFeed(randomEvent, 'mining');
                }
                
                await refreshUserStats();
            }, 5000);
        }

        // Event listeners
        connectBtn.addEventListener('click', connectPhantom);
        stakeBtn.addEventListener('click', () => sendStake());
        quickStake0_5.addEventListener('click', () => sendStake(0.5));
        quickStake1.addEventListener('click', () => sendStake(1));
        quickStake5.addEventListener('click', () => sendStake(5));
        quickStake10.addEventListener('click', () => sendStake(10));

        // Auto-connect on page load
        window.addEventListener('load', async () => {
            phantom = getPhantom();
            if (phantom?.isConnected && phantom.publicKey) {
                walletAddress = phantom.publicKey.toString();
                
                const userData = await loadUserData(walletAddress);
                
                if (userData) {
                    await calculateDailyRewards(userData);
                    
                    walletAddrSpan.innerText = formatAddr(walletAddress);
                    walletInfoDiv.style.display = 'block';
                    connectBtn.innerHTML = '<i class="fab fa-phantom"></i><span class="btn-text">MINING ACTIVE</span>';
                    connectBtn.style.background = 'rgba(0, 255, 170, 0.15)';
                    connectBtn.style.borderColor = '#00ffaa';
                    
                    await refreshUserStats();
                    startMiningSimulation();
                    addToFeed('ðŸ”„ mining rig resumed', 'success');
                }
            }
        });
    </script>
</body>
</html>
